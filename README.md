# 📬 Notification Bot

Автоматичні сповіщення в Telegram про оплати з Google Sheets.

## 🏗️ Архітектура

```
                    ┌──────────────────┐
                    │  Telegram User   │
                    │   /start         │
                    └────────┬─────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────┐
│              NotificationBot Library                │
│  ┌─────────────┐    ┌─────────────┐                 │
│  │  Web App    │    │   Users     │                 │
│  │ (webhook)   │─▶ │  Spreadsheet│                 │
│  └─────────────┘    └──────┬──────┘                 │
│                            │                        │
│         username ──────────┼──────── chat_id        │
│                            │                        │
└─────────────────────────────────────────────────────┘
                             │
       ┌─────────────────────┼─────────────────────┐
       │                     │                     │
       ▼                     ▼                     ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Таблиця 1  │     │  Таблиця 2  │     │  Таблиця N  │
│  (тригер)   │     │  (тригер)   │     │  (тригер)   │
└─────────────┘     └─────────────┘     └─────────────┘
```

**Як це працює:**

1. Користувач пише `/start` боту → бот зберігає `username` і `chat_id`
2. В таблиці вказується `username` в стовпці "Контакти"
3. При заповненні дати оплати → скрипт знаходить `chat_id` за `username` → відправляє повідомлення

---

## 📋 Покрокова інструкція

### Крок 1: Створіть Telegram Bot

1. Відкрийте [@BotFather](https://t.me/BotFather) в Telegram
2. Відправте `/newbot`
3. Введіть назву бота (наприклад: "Payment Notifications")
4. Введіть username бота (наприклад: `cb_payments_notifications_bot`)
5. **Збережіть токен в .env файл** — TELEGRAM_BOT_TOKEN=...

---

### Крок 2: Створіть таблицю для користувачів

1. Створіть нову Google таблицю (наприклад: "NotificationBot Users")
2. Скопіюйте її **ID** з URL:
   ```
   https://docs.google.com/spreadsheets/d/ЦЕЙІДСКОПІЮЙТЕ/edit
   ```
   **в .env файл** - USERS_SPREADSHEET_ID=...
3. Аркуш "Users" буде створено автоматично

---

### Крок 3: Встановіть clasp (локально)

```bash
cd notification-bot
npm install
npm run login
```

---

### Крок 4: Створіть бібліотеку

1. Створіть нову GAS бібліотеку за допомогою web інтерфейсу https://script.google.com/ або за допомогою команди:

```bash
npm run create
```

2. **Збережіть Script ID в .env файл** — SCRIPT_ID=...
   (**Налаштування** (⚙️) → скопіюйте **Script ID** також якщо створювали бібліотеку за допомогою команди можна скопіювати з файлу - ./gas/.clasp.json поле "scriptId")

---

### Крок 5: Налаштуйте Script Properties бібліотеки

1. Відкрийте бібліотеку: `npm run open`
2. **Проект** → **Параметри проекту** → **Властивості скрипту**
3. Додайте з .env файлу:

| Ключ                   | Значення                |
| ---------------------- | ----------------------- |
| `TELEGRAM_BOT_TOKEN`   | Ваш токен від BotFather |
| `USERS_SPREADSHEET_ID` | ID таблиці з Кроку 2    |

---

### Крок 6: Опублікуйте Web App

1. В редакторі бібліотеки: **Deploy** → **New deployment**
2. Тип: **Web app**
3. Налаштування:
   - Execute as: **Me**
   - Who has access: **Anyone**
4. Натисніть **Deploy**
5. **Скопіюйте в .env файл** — WEBAPP_DEPLOYMENT_URL=... та WEBAPP_DEPLOYMENT_ID=...
6. Додайте Script Properties бібліотеки з .env файлу:

| Ключ                    | Значення              |
| ----------------------- | --------------------- |
| `WEBAPP_DEPLOYMENT_URL` | з попереднього пункту |

---

### Крок 7: Встановіть Webhook

1. В редакторі бібліотеки виберіть функцію `setupWebhook`
2. Натисніть **▶ Виконати**
3. В логах побачите: "✅ Webhook успішно встановлено!"

---

### Крок 8: Перевірте бота

1. Напишіть `/start` вашому боту в Telegram
2. Бот має відповісти: "✅ Вітаю! Вас успішно зареєстровано."
3. Перевірте таблицю Users — має з'явитись новий рядок

---

### Крок 9: Налаштуйте робочу таблицю

#### 9.1. Додайте стовпці

| Стовпець | Назва                     | Опис                        |
| -------- | ------------------------- | --------------------------- |
| A-T      | (існуючі стовпці)         | Ваші дані                   |
| **U**    | **Telegram username**     | ← Telegram username (без @) |
| **V**    | **Дата фактичної оплати** | ← Тригер                    |
| **W**    | **Повідомлено**           | ← TRUE після відправки      |

#### 9.2. Створіть скрипт таблиці

1. Відкрийте таблицю
2. **Розширення** → **Apps Script**
3. Вставте код з `gas-client/Code.js`
4. Збережіть

#### 9.3. Підключіть бібліотеку

1. Натисніть **+** біля **Бібліотеки**
2. Вставте **SCRIPT_ID** бібліотеки з .env файлу
3. Ідентифікатор: `NotificationBot`
4. Натисніть **Додати**

#### 9.4. Встановіть тригер

1. Виберіть функцію `setupTrigger`
2. Натисніть **▶ Виконати**

---

## 🧪 Тестування

### Тест 1: Перевірка бота

Напишіть боту `/start` — має прийти підтвердження реєстрації.

### Тест 2: Перевірка сповіщення

В `gas-client/Code.js` запустіть `testNotification()`

### Тест 3: Повний цикл

1. Додайте рядок в таблицю
2. В стовпці U вкажіть свій username (без @)
3. Заповніть дату в стовпці V
4. Має прийти повідомлення в Telegram

---

## 🔄 Додавання нових таблиць

Для кожної нової таблиці:

1. Створіть скрипт (Крок 9.2)
2. Підключіть бібліотеку (Крок 9.3)
3. Встановіть тригер (Крок 9.4)

---

## ⚙️ Налаштування

### Кастомні стовпці

```javascript
const TABLE_CONFIG = {
  columns: {
    CONTRACTOR: 5, // F
    AMOUNT: 10, // K
    ACTUAL_PAYMENT_DATE: 25, // Z
    CONTACT_USERNAME: 26, // AA
    NOTIFIED: 27, // AB
  },
};
```

### Кастомний формат повідомлення

```javascript
const TABLE_CONFIG = {
  formatMessage: function (data) {
    return (
      `🔔 Оплата: ${data.contractor}\n` +
      `Сума: ${data.amount} ${data.currency}`
    );
  },
};
```

### Конкретний аркуш

```javascript
const TABLE_CONFIG = {
  sheetName: "Оплати",
};
```

---

## 📁 Структура проекту

```
notification-bot/
├── gas/                        # Бібліотека
│   ├── src/
│   │   ├── Library.js          # Основна логіка
│   │   └── WebApp.js           # Webhook обробник
│   ├── appsscript.json
│   └── jsconfig.json
├── gas-client/                 # Клієнтський код
│   └── Code.js                 # Для кожної таблиці
├── package.json
└── README.md
```

---

## 🛠️ Команди

| Команда            | Опис                                 |
| ------------------ | ------------------------------------ |
| `npm run login`    | Авторизація в clasp                  |
| `npm run create`   | Створити новий GAS-проєкт            |
| `npm run open`     | Відкрити редактор GAS                |
| `npm run push`     | Завантажити бібліотеку (upload)      |
| `npm run pull`     | Завантажити код з GAS (download)     |
| `npm run watch`    | Автоматичне завантаження при змінах  |
| `npm run redeploy` | Перезапустити деплой через deploy.js |

---

## ✏️ Внесення змін у код

1. Вносьте зміни у вихідні файли у папці `gas/src/` (наприклад, `Library.js`, `WebApp.js`).
2. Після змін виконайте команду:

```bash
npm run push
```

Це завантажить оновлений код у Google Apps Script.

3. Для перевірки — відкрийте редактор GAS (`npm run open`) і переконайтесь, що зміни застосовано.
4. Зробіть ре-деплой Web App (`npm run redeploy`).
5. Після кожної зміни Code.js потрібно вручну скопіювати код в редактор GAS кожної підключеної до бібліотеки таблиці

---

## ❓ FAQ

### Чому бот не відповідає?

- Перевірте webhook: запустіть `checkWebhookStatus()` в бібліотеці
- Перевірте логи: **Виконання** → **Журнал виконання**

### Чому повідомлення не приходять?

- Перевірте, що користувач зареєструвався (`/start`)
- Перевірте username в таблиці (без @)
- Перевірте Script Properties в таблиці

---

## 📜 Ліцензія

MIT
